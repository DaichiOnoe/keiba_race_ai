# [**Simulation results**]
---

### 学習条件

**1. 使用データ:**

* **データソース:** netkeiba
* **取得期間:** 過去約15年間分（2010年〜）
* **取得内容:**
    * レースデータ（過去約15年間分のjraの全レース情報）
    * 該当レースの競走馬の過去成績データ
    * 競走馬の血統データ

**2. 学習データ期間設定:**

データは、各期間が重複しないように以下の目的で区分して使用します。

* **訓練データ (Training Data):**
    * 期間: 2009年〜2023年の間で、**10年ごとに区切った期間**のデータを使用します。
        * 例: 最初の訓練データは2009年〜2018年、次の訓練データは2010年〜2019年、といった形で、モデルの再学習（リトレーニング）を行う際に、訓練期間をスライドさせながら使用することが想定されます。
* **検証データ (Validation Data - Early Stopping用):**
    * 期間: **訓練データ期間の直後の3ヶ月間**のデータを固定して使用します。
        * 例: 訓練データが2009年〜2018年の場合、検証データは2019年1月〜3月を使用します
    * 目的: モデルの過学習を防ぐためのアーリーストッピング（早期終了）の判断に用います。
* **テストデータ (Test Data):**
    * 期間: **検証データの直後のデータ**を使用します。
        * 例: 訓練データが2009年〜2018年の場合、テストデータは2019年の全データを使用します。
        * 例: 訓練データが2014年〜2023年の場合、テストデータは2024年の全データを使用します。
    * 目的: モデルの最終的な性能評価と汎化能力の確認に用います。

---


### 競馬順位予測結果と購入シミュレーション

**予測結果の概要:**
モデルの出力は表形式で、各競走馬について以下の情報を提供します。
* `race_id`、`horse_id`、`target`（1着なら1,それ以外は０）
* `rank`（実際の順位）、`tansho_odds`（単勝オッズ）、`popularity`（人気）、`umaban`（馬番）
* モデルが出力した`pred`（１着になる予測確率）と`pred_calibrated`（キャリブレーション補正後の予測確率）

![Screenshot from 2025-06-05 03-52-48](https://github.com/user-attachments/assets/f9b224c1-4290-4413-9dd7-95f435043165)


**購入シミュレーション結果・評価:**
この予測データを利用し、「**期待値 (`expect_return`) が特定の閾値以上の単勝馬券のみを購入する**」戦略でシミュレーションを行いました。

添付のグラフは、このシミュレーション結果を示しています。
* **横軸:** 購入基準となる`expect_return`（期待値）の閾値
* **左縦軸（青線）:** `return_rate`（回収率）
* **右縦軸（赤線）:** `sharp_ratio`（シャープレシオ）リスクに見合ったリターンがどれだけ得られているかを示す指標。値が大きいほどリスクあたりのリターンが高いと評価される。

![Screenshot from 2025-06-05 02-51-25](https://github.com/user-attachments/assets/963dc281-160e-424b-9298-4e9983e60850)

グラフからは、期待値の閾値を上げるほど回収率（青線）が上昇し、**特に期待値約1.4の地点でシャープレシオ（赤線）がピークに達する**ことが分かります。この戦略により、シミュレーション上では**安定して回収率120%を達成**できることが示されました。


---

### その他の評価指標：予測確率の信頼性（キャリブレーション）

本モデルの評価において、単に予測の正解率だけでなく、**予測された確率がどれだけ実際の確率と一致しているか（キャリブレーション）**も重要な指標として評価しました。

* **横軸 (Predicted probability):** モデルが予測した確率
* **縦軸 (True probability):** 実際に1着になった確率（観測された真の確率）
* **点線 (Perfectly calibrated):** 予測確率と実際の確率が完全に一致する理想的な状態を示す線（$y=x$の直線）
* **青線と点 (Model):** 本モデルの予測確率と実際の確率の関係

  ![Screenshot from 2025-06-05 04-10-49](https://github.com/user-attachments/assets/829cb6dc-ee7b-42f6-9736-27d91002b529)

グラフにおいて、青線が点線に近ければ近いほど、モデルの予測確率が実際の現象と高い精度で一致している、つまり「キャリブレーションが良い」ことを意味します。この図から、本モデルの予測確率は、低確率から高確率の範囲まで比較的理想的な点線に沿っており、高いキャリブレーション性能を持つことが視覚的に確認できます。


このキャリブレーションの度合いは、**Brier Score（ブライアスコア）**という数値指標でも評価しました。

* **Brier Score:** 0.05780

Brier Scoreは、予測確率と実際の事象（1または0）との平均二乗誤差を表し、値が小さいほど予測の精度とキャリブレーションが良いことを示します。

---
